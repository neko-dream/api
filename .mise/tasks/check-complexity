#!/bin/bash
set -euo pipefail

readonly RED='\033[0;31m'
readonly GREEN='\033[0;32m'
readonly YELLOW='\033[1;33m'
readonly BLUE='\033[0;34m'
readonly MAGENTA='\033[0;35m'
readonly CYAN='\033[0;36m'
readonly BOLD='\033[1m'
readonly NC='\033[0m' # No Color

readonly COGNITIVE_THRESHOLD=30
readonly CYCLOMATIC_THRESHOLD=10

print_header() {
    echo -e "${CYAN}${BOLD}"
    echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
    echo "â•‘              Go ã‚³ãƒ¼ãƒ‰è¤‡é›‘åº¦åˆ†æãƒ¬ãƒãƒ¼ãƒˆ                     â•‘"
    echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    echo -e "${NC}"
}

find_go_files() {
    local exclude_paths=(
        "*/vendor/*"
        "*/.git/*"
        "*/.serena/*"
        "*/internal/infrastructure/persistence/sqlc/generated/*"
        "*/internal/presentation/oas/*"
        "*/mock/*"
    )

    local exclude_names=(
        "*.gen.go"
        "*_gen.go"
        "*.sql.go"
        "*.pb.go"
        "*_test.go"
    )

    local find_args=()

    # ãƒ‘ã‚¹ã®é™¤å¤–æ¡ä»¶ã‚’è¿½åŠ 
    for path in "${exclude_paths[@]}"; do
        find_args+=("!" "-path" "$path")
    done

    # ãƒ•ã‚¡ã‚¤ãƒ«åã®é™¤å¤–æ¡ä»¶ã‚’è¿½åŠ 
    for name in "${exclude_names[@]}"; do
        find_args+=("!" "-name" "$name")
    done

    find . -type f -name "*.go" "${find_args[@]}" | sort
}

main() {
    print_header

    echo -e "${GREEN}ğŸ“… åˆ†ææ—¥æ™‚: $(date '+%Yå¹´%mæœˆ%dæ—¥ %H:%M:%S')${NC}"

    local files=$(find_go_files)
    local file_count=$(echo "$files" | wc -l | tr -d ' ')
    echo -e "${GREEN}ğŸ“ åˆ†æå¯¾è±¡: ${file_count} ãƒ•ã‚¡ã‚¤ãƒ«ï¼ˆè‡ªå‹•ç”Ÿæˆé™¤ãï¼‰${NC}"
    echo ""

    # èªçŸ¥çš„è¤‡é›‘åº¦åˆ†æï¼ˆgocognitï¼‰
    if command -v go tool gocognit &> /dev/null; then
        echo -e "${MAGENTA}${BOLD}ğŸ§  èªçŸ¥çš„è¤‡é›‘åº¦ãŒé«˜ã„é–¢æ•°ï¼ˆ${COGNITIVE_THRESHOLD}ä»¥ä¸Šï¼‰${NC}"
        echo -e "${CYAN}â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€${NC}"

        local cognitive_results=$(echo "$files" | xargs go tool gocognit -over $COGNITIVE_THRESHOLD 2>/dev/null)
        if [[ -n "$cognitive_results" ]]; then
            # çµæœã‚’1è¡Œãšã¤å‡¦ç†ã—ã¦è‰²ä»˜ã‘
            while IFS= read -r line; do
                if [[ $line =~ ^([0-9]+)[[:space:]]+(.+) ]]; then
                    local complexity="${BASH_REMATCH[1]}"
                    local location="${BASH_REMATCH[2]}"

                    # èªçŸ¥çš„è¤‡é›‘åº¦ãƒ¬ãƒ™ãƒ«ã«å¿œã˜ãŸè‰²ã®åˆ¤å®š
                    if [ "$complexity" -le 7 ]; then
                        local color="${GREEN}"
                    elif [ "$complexity" -le 15 ]; then
                        local color="${YELLOW}"
                    elif [ "$complexity" -le 25 ]; then
                        local color="${YELLOW}${BOLD}"
                    elif [ "$complexity" -le 40 ]; then
                        local color="${RED}"
                    else
                        local color="${RED}${BOLD}"
                    fi

                    # è‰²ä»˜ãã§å‡ºåŠ›
                    echo -e "${color}${complexity} ${location}${NC}"
                else
                    echo "$line"
                fi
            done <<< "$cognitive_results"

            local cognitive_count=$(echo "$cognitive_results" | wc -l)
            echo ""
            echo -e "${YELLOW}âš ï¸  ${cognitive_count}å€‹ã®é–¢æ•°ãŒè¦ãƒªãƒ•ã‚¡ã‚¯ã‚¿ãƒªãƒ³ã‚°å¯¾è±¡ã§ã™${NC}"
        else
            echo -e "${GREEN}âœ… èªçŸ¥çš„è¤‡é›‘åº¦${COGNITIVE_THRESHOLD}ä»¥ä¸Šã®é–¢æ•°ã¯ã‚ã‚Šã¾ã›ã‚“${NC}"
        fi
        echo ""
    else
        echo -e "${YELLOW}âš ï¸  gocognitãŒã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã•ã‚Œã¦ã„ã¾ã›ã‚“ï¼ˆèªçŸ¥çš„è¤‡é›‘åº¦åˆ†æã‚’ã‚¹ã‚­ãƒƒãƒ—ï¼‰${NC}"
        echo -e "${YELLOW}   ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«æ–¹æ³•: go get tool${NC}"
        echo ""
    fi

    # å¾ªç’°çš„è¤‡é›‘åº¦åˆ†æï¼ˆgocycloï¼‰
    if command -v go tool gocyclo &> /dev/null; then
        echo -e "${BLUE}${BOLD}ğŸ”„ å¾ªç’°çš„è¤‡é›‘åº¦ãŒé«˜ã„é–¢æ•°ï¼ˆ${CYCLOMATIC_THRESHOLD}ä»¥ä¸Šï¼‰${NC}"
        echo -e "${CYAN}â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€${NC}"

        local cyclo_results=$(echo "$files" | xargs go tool gocyclo -over $CYCLOMATIC_THRESHOLD 2>/dev/null)
        if [[ -n "$cyclo_results" ]]; then
            # çµæœã‚’1è¡Œãšã¤å‡¦ç†ã—ã¦è‰²ä»˜ã‘
            while IFS= read -r line; do
                if [[ $line =~ ^([0-9]+)[[:space:]]+(.+) ]]; then
                    local complexity="${BASH_REMATCH[1]}"
                    local location="${BASH_REMATCH[2]}"

                    # è¤‡é›‘åº¦ãƒ¬ãƒ™ãƒ«ã«å¿œã˜ãŸè‰²ã®åˆ¤å®š
                    if [ "$complexity" -le 10 ]; then
                        local color="${GREEN}"
                    elif [ "$complexity" -lt 30 ]; then
                        local color="${YELLOW}"
                    elif [ "$complexity" -lt 50 ]; then
                        local color="${YELLOW}${BOLD}"
                    elif [ "$complexity" -lt 75 ]; then
                        local color="${RED}"
                    else
                        local color="${RED}${BOLD}"
                    fi

                    # è‰²ä»˜ãã§å‡ºåŠ›
                    echo -e "${color}${complexity} ${location}${NC}"
                else
                    echo "$line"
                fi
            done <<< "$cyclo_results"

            local cyclo_count=$(echo "$cyclo_results" | wc -l)
            echo ""
            echo -e "${YELLOW}âš ï¸  ${cyclo_count}å€‹ã®é–¢æ•°ãŒè¦ç¢ºèªå¯¾è±¡ã§ã™${NC}"
        else
            echo -e "${GREEN}âœ… å¾ªç’°çš„è¤‡é›‘åº¦${CYCLOMATIC_THRESHOLD}ä»¥ä¸Šã®é–¢æ•°ã¯ã‚ã‚Šã¾ã›ã‚“${NC}"
        fi
        echo ""
    else
        echo -e "${YELLOW}âš ï¸  gocycloãŒã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã•ã‚Œã¦ã„ã¾ã›ã‚“ï¼ˆå¾ªç’°çš„è¤‡é›‘åº¦åˆ†æã‚’ã‚¹ã‚­ãƒƒãƒ—ï¼‰${NC}"
        echo -e "${YELLOW}   ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«æ–¹æ³•: go get tool${NC}"
        echo ""
    fi

    echo -e "${YELLOW}${BOLD}ğŸ“Š ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆå…¨ä½“ã®çµ±è¨ˆ${NC}"
    echo -e "${CYAN}â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€${NC}"
    echo "$files" | xargs go tool scc | grep -E "^Go|^Language|^Estimated"
    echo -e "${CYAN}â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€${NC}"

    # æ¨å¥¨äº‹é …
    echo ""
    echo -e "${GREEN}${BOLD}ğŸ’¡ ãƒªãƒ•ã‚¡ã‚¯ã‚¿ãƒªãƒ³ã‚°æ¨å¥¨äº‹é …${NC}"
    echo -e "  ${YELLOW}â—${NC} èªçŸ¥çš„è¤‡é›‘åº¦ â‰¥${COGNITIVE_THRESHOLD} ã®é–¢æ•°ã¯åˆ†å‰²ã‚’æ¤œè¨ã—ã¦ãã ã•ã„"
    echo -e "  ${YELLOW}â—${NC} å¾ªç’°çš„è¤‡é›‘åº¦ â‰¥${CYCLOMATIC_THRESHOLD} ã®é–¢æ•°ã¯æ¡ä»¶åˆ†å²ã®ç°¡ç•¥åŒ–ã‚’æ¤œè¨ã—ã¦ãã ã•ã„"
    echo -e "  ${YELLOW}â—${NC} è¤‡æ•°ã®è¤‡é›‘åº¦æŒ‡æ¨™ã§ä¸Šä½ã«å…¥ã‚‹ãƒ•ã‚¡ã‚¤ãƒ«ã‚’å„ªå…ˆçš„ã«ãƒªãƒ•ã‚¡ã‚¯ã‚¿ãƒªãƒ³ã‚°ã—ã¦ãã ã•ã„"

    # è¤‡é›‘åº¦ã®è§£èª¬
    echo ""
    echo -e "${CYAN}${BOLD}ğŸ“– è¤‡é›‘åº¦ã®ç›®å®‰${NC}"
    echo -e "${BOLD}å¾ªç’°çš„è¤‡é›‘åº¦:${NC}"
    echo -e "  ${GREEN}â— 10ä»¥ä¸‹${NC}: éå¸¸ã«è‰¯ã„æ§‹é€  (ãƒã‚°æ··å…¥ç¢ºç‡: 25%)"
    echo -e "  ${YELLOW}â— 30ä»¥ä¸Š${NC}: æ§‹é€ çš„ãªãƒªã‚¹ã‚¯ã‚ã‚Š (ãƒã‚°æ··å…¥ç¢ºç‡: 40%)"
    echo -e "  ${RED}â— 50ä»¥ä¸Š${NC}: ãƒ†ã‚¹ãƒˆä¸å¯èƒ½ (ãƒã‚°æ··å…¥ç¢ºç‡: 70%)"
    echo -e "  ${RED}${BOLD}â— 75ä»¥ä¸Š${NC}: ã„ã‹ãªã‚‹å¤‰æ›´ã‚‚èª¤ä¿®æ­£ã‚’ç”Ÿã‚€ (ãƒã‚°æ··å…¥ç¢ºç‡: 98%)"
    echo ""
    echo -e "${BOLD}èªçŸ¥çš„è¤‡é›‘åº¦:${NC}"
    echo -e "  ${GREEN}â— 7ä»¥ä¸‹${NC}: éå¸¸ã«è‰¯ã„æ§‹é€ "
    echo -e "  ${YELLOW}â— 8-15${NC}: è‰¯ã„æ§‹é€ "
    echo -e "  ${YELLOW}${BOLD}â— 16-25${NC}: æ§‹é€ çš„ãªãƒªã‚¹ã‚¯ã‚ã‚Š"
    echo -e "  ${RED}â— 26-40${NC}: ç†è§£å›°é›£ãƒ»ãƒ†ã‚¹ãƒˆå›°é›£"
    echo -e "  ${RED}${BOLD}â— 40ä»¥ä¸Š${NC}: ã„ã‹ãªã‚‹å¤‰æ›´ã‚‚èª¤ä¿®æ­£ã‚’ç”Ÿã‚€"
    echo ""
}

echo -e "${CYAN}ğŸ” å¿…è¦ãªãƒ„ãƒ¼ãƒ«ã‚’ç¢ºèªä¸­...${NC}"

# sccãŒã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã•ã‚Œã¦ã„ã‚‹ã‹ç¢ºèª
if ! command -v go tool scc &> /dev/null; then
    echo -e "${RED}âŒ ã‚¨ãƒ©ãƒ¼: sccãŒã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã•ã‚Œã¦ã„ã¾ã›ã‚“${NC}"
    echo -e "${YELLOW}ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«æ–¹æ³•: go get tool${NC}"
    exit 1
fi

tools_status="ãƒ„ãƒ¼ãƒ«çŠ¶æ…‹: "
if command -v go tool gocognit &> /dev/null; then
    tools_status="${tools_status}${GREEN}âœ…${NC} gocognit "
else
    tools_status="${tools_status}${YELLOW}âŒ${NC} gocognit "
fi

if command -v go tool gocyclo &> /dev/null; then
    tools_status="${tools_status}${GREEN}âœ…${NC} gocyclo"
else
    tools_status="${tools_status}${YELLOW}âŒ${NC} gocyclo"
fi

echo -e "$tools_status"
echo ""

main

exit 0
