<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kotohiro Web Push Notification Test</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background-color: white;
            border-radius: 8px;
            padding: 30px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1 {
            color: #333;
            text-align: center;
            margin-bottom: 30px;
        }
        h3 {
            color: #555;
            margin-top: 30px;
        }
        .status {
            padding: 15px;
            border-radius: 4px;
            margin-bottom: 20px;
            font-weight: bold;
        }
        .status.info {
            background-color: #e3f2fd;
            color: #1976d2;
        }
        .status.success {
            background-color: #e8f5e9;
            color: #388e3c;
        }
        .status.warning {
            background-color: #fff3e0;
            color: #f57c00;
        }
        .status.error {
            background-color: #ffebee;
            color: #d32f2f;
        }
        button {
            background-color: #4CAF50;
            color: white;
            border: none;
            padding: 10px 20px;
            font-size: 16px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
            transition: background-color 0.3s;
        }
        button:hover:not(:disabled) {
            background-color: #45a049;
        }
        button:disabled {
            background-color: #cccccc;
            cursor: not-allowed;
        }
        .section {
            margin: 20px 0;
            padding: 20px;
            border: 1px solid #e0e0e0;
            border-radius: 4px;
        }
        .token-display {
            background-color: #f5f5f5;
            padding: 10px;
            border-radius: 4px;
            font-family: monospace;
            font-size: 12px;
            word-break: break-all;
            margin-top: 10px;
        }
        .device-item {
            padding: 10px;
            margin: 5px 0;
            background-color: #f9f9f9;
            border-radius: 4px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .log-container {
            margin-top: 30px;
            padding: 15px;
            background-color: #263238;
            color: #aed581;
            border-radius: 4px;
            font-family: monospace;
            font-size: 12px;
            max-height: 300px;
            overflow-y: auto;
        }
        .log-entry {
            margin: 2px 0;
        }
        .log-entry.error {
            color: #ef5350;
        }
        .log-entry.success {
            color: #66bb6a;
        }
        .log-entry.warning {
            color: #ffa726;
        }
        .user-info {
            background-color: #e8f5e9;
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ”” Kotohiro Web Push Notification Test</h1>

        <!-- èªè¨¼ã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
        <div class="section">
            <h3>ğŸ‘¤ èªè¨¼çŠ¶æ…‹</h3>
            <div id="authStatus" class="status warning">
                èªè¨¼çŠ¶æ…‹ã‚’ç¢ºèªä¸­...
            </div>
            <div id="userInfo" class="user-info" style="display: none;">
                <strong>ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±</strong><br>
                è¡¨ç¤ºID: <span id="displayId"></span><br>
                ãƒ¦ãƒ¼ã‚¶ãƒ¼ID: <span id="userId"></span>
            </div>
            <button id="loginBtn" onclick="login()" style="display: none;">
                é–‹ç™ºç”¨ãƒ­ã‚°ã‚¤ãƒ³
            </button>
            <button id="logoutBtn" onclick="logout()" style="display: none;">
                ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ
            </button>
        </div>

        <!-- é€šçŸ¥æ¨©é™ã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
        <div id="permissionSection" class="section" style="display: none;">
            <h3>ğŸ”” é€šçŸ¥æ¨©é™</h3>
            <div id="permissionStatus" class="status info">
                é€šçŸ¥æ¨©é™ã‚’ç¢ºèªä¸­...
            </div>
            <button id="requestPermissionBtn" onclick="requestNotificationPermission()">
                é€šçŸ¥æ¨©é™ã‚’ãƒªã‚¯ã‚¨ã‚¹ãƒˆ
            </button>
        </div>

        <!-- FCMãƒˆãƒ¼ã‚¯ãƒ³ã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
        <div id="tokenSection" class="section" style="display: none;">
            <h3>ğŸ”‘ FCMãƒˆãƒ¼ã‚¯ãƒ³</h3>
            <button id="getTokenBtn" onclick="getFCMToken()" disabled>
                FCMãƒˆãƒ¼ã‚¯ãƒ³ã‚’å–å¾—
            </button>
            <div id="tokenDisplay" class="token-display" style="display: none;">
                <strong>Token:</strong> <span id="tokenValue"></span>
            </div>
        </div>

        <!-- ãƒ‡ãƒã‚¤ã‚¹ç®¡ç†ã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
        <div id="deviceSection" class="section" style="display: none;">
            <h3>ğŸ“± ãƒ‡ãƒã‚¤ã‚¹ç®¡ç†</h3>
            <button id="registerDeviceBtn" onclick="registerDevice()" disabled>
                ã“ã®ãƒ‡ãƒã‚¤ã‚¹ã‚’ç™»éŒ²
            </button>
            <button id="refreshDevicesBtn" onclick="fetchDevices()">
                ãƒ‡ãƒã‚¤ã‚¹ä¸€è¦§ã‚’æ›´æ–°
            </button>
            <div id="deviceList" style="margin-top: 15px;"></div>
        </div>

        <!-- ãƒ†ã‚¹ãƒˆé€šçŸ¥ã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
        <div id="testSection" class="section" style="display: none;">
            <h3>ğŸš€ ãƒ†ã‚¹ãƒˆé€šçŸ¥</h3>
            <button id="sendTestBtn" onclick="sendTestNotification()" disabled>
                ãƒ†ã‚¹ãƒˆé€šçŸ¥ã‚’é€ä¿¡
            </button>
            <div style="margin-top: 10px;">
                <input type="text" id="testTitle" placeholder="é€šçŸ¥ã‚¿ã‚¤ãƒˆãƒ« (ã‚ªãƒ—ã‚·ãƒ§ãƒ³)" style="width: 100%; padding: 5px; margin: 5px 0;">
                <input type="text" id="testBody" placeholder="é€šçŸ¥æœ¬æ–‡ (ã‚ªãƒ—ã‚·ãƒ§ãƒ³)" style="width: 100%; padding: 5px; margin: 5px 0;">
            </div>
        </div>

        <!-- ãƒ­ã‚°è¡¨ç¤º -->
        <div class="log-container">
            <div id="logs"></div>
        </div>
    </div>

    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/11.1.0/firebase-app.js';
        import { getMessaging, getToken, onMessage } from 'https://www.gstatic.com/firebasejs/11.1.0/firebase-messaging.js';

        // Firebaseè¨­å®š
        const firebaseConfig = {
            apiKey: "AIzaSyBEQ-gqPCUMyyBZ-YP10t_0X0D01BGPCgQ",
            authDomain: "kotohiro-dev-c57a8.firebaseapp.com",
            projectId: "kotohiro-dev-c57a8",
            storageBucket: "kotohiro-dev-c57a8.firebasestorage.app",
            messagingSenderId: "1023394330741",
            appId: "1:1023394330741:web:d31f1b8176164e8903a03c"
        };

        // APIã‚µãƒ¼ãƒãƒ¼ã®ãƒ™ãƒ¼ã‚¹URLï¼ˆç¾åœ¨ã®ã‚ªãƒªã‚¸ãƒ³ã‚’ä½¿ç”¨ï¼‰
        const API_BASE_URL = window.location.origin;

        // ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°
        let messaging;
        let currentUser = null;
        let fcmToken = null;
        let vapidKey = null;

        // FirebaseåˆæœŸåŒ–
        const app = initializeApp(firebaseConfig);
        messaging = getMessaging(app);

        // ãƒ­ã‚°è¡¨ç¤ºé–¢æ•°
        function addLog(message, type = 'info') {
            const logs = document.getElementById('logs');
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = document.createElement('div');
            logEntry.className = `log-entry ${type}`;
            logEntry.textContent = `[${timestamp}] ${message}`;
            logs.appendChild(logEntry);
            logs.scrollTop = logs.scrollHeight;
        }

        // VAPID Keyã‚’å–å¾—
        async function fetchVapidKey() {
            try {
                const response = await fetch(`${API_BASE_URL}/notifications/vapid-key`);
                if (response.ok) {
                    const data = await response.json();
                    vapidKey = data.vapid_key;
                    addLog('VAPID Keyå–å¾—æˆåŠŸ', 'success');
                    return true;
                } else {
                    addLog('VAPID Keyå–å¾—å¤±æ•—', 'error');
                    return false;
                }
            } catch (error) {
                addLog(`VAPID Keyå–å¾—ã‚¨ãƒ©ãƒ¼: ${error.message}`, 'error');
                return false;
            }
        }

        // èªè¨¼çŠ¶æ…‹ã‚’ãƒã‚§ãƒƒã‚¯
        async function checkAuthStatus() {
            try {
                addLog('èªè¨¼çŠ¶æ…‹ã‚’ç¢ºèªä¸­...', 'info');
                const response = await fetch(`${API_BASE_URL}/auth/token/info`, {
                    credentials: 'include',
                });
                console.log('Auth check response:', response);

                if (response.ok) {
                    const data = await response.json();
                    currentUser = data;

                    // displayIDãŒå«ã¾ã‚Œã¦ã„ãªã„å ´åˆ
                    if (!data.displayID) {
                        // ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã‹ã‚‰ä¿ç•™ä¸­ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼IDã‚’ç¢ºèª
                        const pendingUserId = sessionStorage.getItem('pendingUserId');
                        if (pendingUserId) {
                            sessionStorage.removeItem('pendingUserId');
                            // ãƒ¦ãƒ¼ã‚¶ãƒ¼ç™»éŒ²ã‚’å®Ÿè¡Œ
                            await checkAndRegisterUser(pendingUserId);
                            // ç™»éŒ²å¾Œã€å†åº¦èªè¨¼æƒ…å ±ã‚’å–å¾—
                            const updatedResponse = await fetch(`${API_BASE_URL}/auth/token/info`, {
                                credentials: 'include',
                            });
                            if (updatedResponse.ok) {
                                const updatedData = await updatedResponse.json();
                                currentUser = updatedData;
                                data.displayID = updatedData.displayID;
                            }
                        } else {
                            // pendingUserIdãŒãªã„å ´åˆã¯å†åº¦ãƒ­ã‚°ã‚¤ãƒ³ã‚’ä¿ƒã™
                            window.login();
                            return;
                        }
                    }

                    updateAuthUI(true, data);
                    addLog(`ãƒ­ã‚°ã‚¤ãƒ³æ¸ˆã¿: ${data.displayID || data.sub}`, 'success');

                    // èªè¨¼æ¸ˆã¿ã®å ´åˆã¯ä»–ã®ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚’è¡¨ç¤º
                    document.getElementById('permissionSection').style.display = 'block';
                    document.getElementById('tokenSection').style.display = 'block';
                    document.getElementById('deviceSection').style.display = 'block';
                    document.getElementById('testSection').style.display = 'block';

                    // é€šçŸ¥æ¨©é™ã‚’ãƒã‚§ãƒƒã‚¯
                    checkNotificationPermission();
                    // ãƒ‡ãƒã‚¤ã‚¹ä¸€è¦§ã‚’å–å¾—
                    await fetchDevices();
                } else {
                    updateAuthUI(false);
                    addLog('æœªãƒ­ã‚°ã‚¤ãƒ³çŠ¶æ…‹', 'warning');
                }
            } catch (error) {
                addLog(`èªè¨¼ãƒã‚§ãƒƒã‚¯ã‚¨ãƒ©ãƒ¼: ${error.message}`, 'error');
                updateAuthUI(false);
            }
        }

        // èªè¨¼UIã‚’æ›´æ–°
        function updateAuthUI(isAuthenticated, userData = null) {
            const authStatus = document.getElementById('authStatus');
            const userInfo = document.getElementById('userInfo');
            const loginBtn = document.getElementById('loginBtn');
            const logoutBtn = document.getElementById('logoutBtn');

            if (isAuthenticated && userData) {
                authStatus.className = 'status success';
                authStatus.textContent = 'ãƒ­ã‚°ã‚¤ãƒ³æ¸ˆã¿';
                userInfo.style.display = 'block';
                document.getElementById('displayId').textContent = userData.displayID || 'N/A';
                document.getElementById('userId').textContent = userData.sub || 'N/A';
                loginBtn.style.display = 'none';
                logoutBtn.style.display = 'inline-block';
            } else {
                authStatus.className = 'status error';
                authStatus.textContent = 'æœªãƒ­ã‚°ã‚¤ãƒ³';
                userInfo.style.display = 'none';
                loginBtn.style.display = 'inline-block';
                logoutBtn.style.display = 'none';
            }
        }

        // ãƒ­ã‚°ã‚¤ãƒ³
        window.login = async function() {
            const displayId = prompt('è¡¨ç¤ºIDã‚’å…¥åŠ›ã—ã¦ãã ã•ã„:', 'testuser');
            if (!displayId) return;

            // ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã«è¡¨ç¤ºIDã‚’ä¿å­˜ï¼ˆãƒ­ã‚°ã‚¤ãƒ³å¾Œã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ç™»éŒ²ç”¨ï¼‰
            sessionStorage.setItem('pendingUserId', displayId);

            // ãƒ­ã‚°ã‚¤ãƒ³å‡¦ç†ï¼ˆGETãƒªã‚¯ã‚¨ã‚¹ãƒˆï¼‰
            const redirectUrl = encodeURIComponent(window.location.href);
            const loginUrl = `/auth/dev/login?id=${displayId}&redirect_url=${redirectUrl}`;

            // ãƒ–ãƒ©ã‚¦ã‚¶ã§GETãƒªã‚¯ã‚¨ã‚¹ãƒˆï¼ˆãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆï¼‰
            window.location.href = loginUrl;
        };

        // ãƒ¦ãƒ¼ã‚¶ãƒ¼ç™»éŒ²
        async function checkAndRegisterUser(displayId) {
            try {
                // ãƒ¦ãƒ¼ã‚¶ãƒ¼ç™»éŒ²ã‚’è©¦ã¿ã‚‹
                addLog('ãƒ¦ãƒ¼ã‚¶ãƒ¼ç™»éŒ²ã‚’è©¦è¡Œä¸­...', 'info');
                const formData = new FormData();
                formData.append('displayName', displayId);
                formData.append('displayID', displayId);

                const registerResponse = await fetch(`${API_BASE_URL}/user`, {
                    method: 'POST',
                    credentials: 'include',
                    body: formData
                });

                if (registerResponse.ok) {
                    addLog('æ–°è¦ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’ç™»éŒ²ã—ã¾ã—ãŸ', 'success');
                } else if (registerResponse.status === 409) {
                    addLog('æ—¢å­˜ãƒ¦ãƒ¼ã‚¶ãƒ¼ã§ã™', 'info');
                } else {
                    addLog('ãƒ¦ãƒ¼ã‚¶ãƒ¼ç™»éŒ²ã‚¨ãƒ©ãƒ¼', 'warning');
                }
            } catch (error) {
                addLog(`ãƒ¦ãƒ¼ã‚¶ãƒ¼ç™»éŒ²ã‚¨ãƒ©ãƒ¼: ${error.message}`, 'warning');
            }
        }

        // ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ
        window.logout = async function() {
            try {
                const response = await fetch(`/auth/revoke`, {
                    method: 'POST',
                    credentials: 'include'
                });

                if (response.ok) {
                    addLog('ãƒ­ã‚°ã‚¢ã‚¦ãƒˆã—ã¾ã—ãŸ', 'success');
                    location.reload();
                }
            } catch (error) {
                addLog(`ãƒ­ã‚°ã‚¢ã‚¦ãƒˆã‚¨ãƒ©ãƒ¼: ${error.message}`, 'error');
            }
        };

        // é€šçŸ¥æ¨©é™ã‚’ãƒã‚§ãƒƒã‚¯
        function checkNotificationPermission() {
            const status = Notification.permission;
            const permissionStatus = document.getElementById('permissionStatus');
            const requestBtn = document.getElementById('requestPermissionBtn');

            if (status === 'granted') {
                permissionStatus.className = 'status success';
                permissionStatus.textContent = 'é€šçŸ¥æ¨©é™: è¨±å¯æ¸ˆã¿';
                requestBtn.style.display = 'none';
                document.getElementById('getTokenBtn').disabled = false;
                addLog('é€šçŸ¥æ¨©é™ã¯è¨±å¯ã•ã‚Œã¦ã„ã¾ã™', 'success');
            } else if (status === 'denied') {
                permissionStatus.className = 'status error';
                permissionStatus.textContent = 'é€šçŸ¥æ¨©é™: æ‹’å¦ã•ã‚Œã¦ã„ã¾ã™';
                requestBtn.disabled = true;
                addLog('é€šçŸ¥æ¨©é™ãŒæ‹’å¦ã•ã‚Œã¦ã„ã¾ã™', 'error');
            } else {
                permissionStatus.className = 'status warning';
                permissionStatus.textContent = 'é€šçŸ¥æ¨©é™: æœªè¨­å®š';
                addLog('é€šçŸ¥æ¨©é™ãŒæœªè¨­å®šã§ã™', 'warning');
            }
        }

        // é€šçŸ¥æ¨©é™ã‚’ãƒªã‚¯ã‚¨ã‚¹ãƒˆ
        window.requestNotificationPermission = async function() {
            try {
                const permission = await Notification.requestPermission();
                if (permission === 'granted') {
                    addLog('é€šçŸ¥æ¨©é™ãŒè¨±å¯ã•ã‚Œã¾ã—ãŸ', 'success');
                    checkNotificationPermission();
                } else {
                    addLog('é€šçŸ¥æ¨©é™ãŒæ‹’å¦ã•ã‚Œã¾ã—ãŸ', 'error');
                }
            } catch (error) {
                addLog(`æ¨©é™ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚¨ãƒ©ãƒ¼: ${error.message}`, 'error');
            }
        };

        // FCMãƒˆãƒ¼ã‚¯ãƒ³ã‚’å–å¾—
        window.getFCMToken = async function() {
            try {
                addLog('FCMãƒˆãƒ¼ã‚¯ãƒ³ã‚’å–å¾—ä¸­...', 'info');

                // VAPID KeyãŒãªã„å ´åˆã¯å–å¾—
                if (!vapidKey) {
                    addLog('VAPID Keyã‚’å–å¾—ä¸­...', 'info');
                    const success = await fetchVapidKey();
                    if (!success) {
                        addLog('VAPID Keyã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ', 'error');
                        return;
                    }
                }

                // Service Workerã‚’ç™»éŒ²
                const registration = await navigator.serviceWorker.register('/static/firebase-messaging-sw.js');
                addLog('Service Workerã‚’ç™»éŒ²ã—ã¾ã—ãŸ', 'success');

                // Service Workerã‹ã‚‰ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å—ä¿¡
                navigator.serviceWorker.addEventListener('message', (event) => {
                    if (event.data && event.data.type === 'SW_LOG') {
                        console.log('[SW]', event.data.message);
                        addLog(`[SW] ${event.data.message}`, 'info');
                    }
                });

                // Service WorkerãŒæº–å‚™ã§ããŸã‚‰ãƒ­ã‚°è»¢é€ã‚’æœ‰åŠ¹åŒ–
                await navigator.serviceWorker.ready;
                if (registration.active) {
                    registration.active.postMessage({ type: 'ENABLE_LOG_FORWARDING' });
                }

                // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãƒªã‚¹ãƒŠãƒ¼ã‚’è¨­å®š
                setupMessageListener();

                // ãƒˆãƒ¼ã‚¯ãƒ³ã‚’å–å¾—
                const token = await getToken(messaging, {
                    vapidKey: vapidKey,
                    serviceWorkerRegistration: registration
                });

                if (token) {
                    fcmToken = token;
                    document.getElementById('tokenValue').textContent = token;
                    document.getElementById('tokenDisplay').style.display = 'block';
                    document.getElementById('registerDeviceBtn').disabled = false;
                    document.getElementById('sendTestBtn').disabled = false;
                    addLog('FCMãƒˆãƒ¼ã‚¯ãƒ³ã‚’å–å¾—ã—ã¾ã—ãŸ', 'success');
                } else {
                    addLog('FCMãƒˆãƒ¼ã‚¯ãƒ³ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ', 'error');
                }
            } catch (error) {
                addLog(`ãƒˆãƒ¼ã‚¯ãƒ³å–å¾—ã‚¨ãƒ©ãƒ¼: ${error.message}`, 'error');
                console.error('Token error:', error);
            }
        };

        // ãƒ‡ãƒã‚¤ã‚¹ã‚’ç™»éŒ²
        window.registerDevice = async function() {
            if (!fcmToken) {
                addLog('FCMãƒˆãƒ¼ã‚¯ãƒ³ãŒå¿…è¦ã§ã™', 'error');
                return;
            }

            try {
                addLog('ãƒ‡ãƒã‚¤ã‚¹ã‚’ç™»éŒ²ä¸­...', 'info');

                const formData = new FormData();
                formData.append('device_token', fcmToken);
                formData.append('platform', 'web');
                formData.append('device_name', navigator.userAgent.substring(0, 100));
                formData.append('app_version', '1.0.0');
                formData.append('os_version', navigator.platform);

                const response = await fetch(`/notifications/devices`, {
                    method: 'POST',
                    credentials: 'include',
                    body: formData
                });

                if (response.ok) {
                    const data = await response.json();
                    addLog(`ãƒ‡ãƒã‚¤ã‚¹ã‚’ç™»éŒ²ã—ã¾ã—ãŸ: ${data.device_id}`, 'success');
                    document.getElementById('sendTestBtn').disabled = false;
                    await fetchDevices();
                } else {
                    const error = await response.json();
                    addLog(`ãƒ‡ãƒã‚¤ã‚¹ç™»éŒ²ã‚¨ãƒ©ãƒ¼: ${error.message}`, 'error');
                }
            } catch (error) {
                addLog(`ãƒ‡ãƒã‚¤ã‚¹ç™»éŒ²ã‚¨ãƒ©ãƒ¼: ${error.message}`, 'error');
            }
        };

        // ãƒ‡ãƒã‚¤ã‚¹ä¸€è¦§ã‚’å–å¾—
        window.fetchDevices = async function() {
            try {
                const response = await fetch(`/notifications/devices`, {
                    credentials: 'include'
                });

                if (response.ok) {
                    const data = await response.json();
                    displayDevices(data.devices);
                }
            } catch (error) {
                addLog(`ãƒ‡ãƒã‚¤ã‚¹å–å¾—ã‚¨ãƒ©ãƒ¼: ${error.message}`, 'error');
            }
        };

        // ãƒ‡ãƒã‚¤ã‚¹ä¸€è¦§ã‚’è¡¨ç¤º
        function displayDevices(devices) {
            const deviceList = document.getElementById('deviceList');

            if (devices.length === 0) {
                deviceList.innerHTML = '<em>ç™»éŒ²æ¸ˆã¿ãƒ‡ãƒã‚¤ã‚¹ãªã—</em>';
                return;
            }

            deviceList.innerHTML = devices.map(device => `
                <div class="device-item">
                    <div>
                        <strong>${device.platform}</strong><br>
                        <small>ID: ${device.device_id.substring(0, 8)}...</small><br>
                        <small>ç™»éŒ²æ—¥: ${new Date(device.created_at).toLocaleDateString()}</small>
                    </div>
                    <div>
                        ${device.enabled ? 'âœ… æœ‰åŠ¹' : 'âŒ ç„¡åŠ¹'}
                    </div>
                </div>
            `).join('');
        }

        // ãƒ†ã‚¹ãƒˆé€šçŸ¥ã‚’é€ä¿¡
        window.sendTestNotification = async function() {
            try {
                const title = document.getElementById('testTitle').value || 'Kotohiro ãƒ†ã‚¹ãƒˆé€šçŸ¥';
                const body = document.getElementById('testBody').value || `ãƒ†ã‚¹ãƒˆé€šçŸ¥ã§ã™ (${new Date().toLocaleTimeString()})`;

                addLog('ãƒ†ã‚¹ãƒˆé€šçŸ¥ã‚’é€ä¿¡ä¸­...', 'info');

                const formData = new FormData();
                formData.append('title', title);
                formData.append('body', body);

                const response = await fetch(`/notifications/test`, {
                    method: 'POST',
                    credentials: 'include',
                    body: formData
                });

                if (response.ok) {
                    const data = await response.json();
                    addLog(`ãƒ†ã‚¹ãƒˆé€šçŸ¥ã‚’é€ä¿¡ã—ã¾ã—ãŸ: ${data.devices_count}å°ã®ãƒ‡ãƒã‚¤ã‚¹ã«é€ä¿¡`, 'success');
                } else {
                    const error = await response.json();
                    addLog(`é€šçŸ¥é€ä¿¡ã‚¨ãƒ©ãƒ¼: ${error.message}`, 'error');
                }
            } catch (error) {
                addLog(`é€šçŸ¥é€ä¿¡ã‚¨ãƒ©ãƒ¼: ${error.message}`, 'error');
            }
        };

        // ãƒ•ã‚©ã‚¢ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰ã§ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å—ä¿¡
        onMessage(messaging, (payload) => {
            addLog('ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å—ä¿¡ã—ã¾ã—ãŸ', 'success');
            console.log('Message received:', payload);

            // ãƒ•ã‚©ã‚¢ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰ã§é€šçŸ¥ã‚’è¡¨ç¤º
            if (Notification.permission === 'granted') {
                // Pinpointã‹ã‚‰ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã¯dataãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã«é€šçŸ¥å†…å®¹ãŒå«ã¾ã‚Œã‚‹å ´åˆãŒã‚ã‚‹
                const title = payload.notification?.title || payload.data?.title || 'Kotohiro';
                const body = payload.notification?.body || payload.data?.body || '';
                const icon = payload.notification?.icon || payload.data?.icon || '/icon-192x192.png';

                new Notification(title, {
                    body: body,
                    icon: icon
                });
            }
        });

        // ãƒ•ã‚©ã‚¢ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰ã§ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å—ä¿¡ï¼ˆãƒ‡ãƒãƒƒã‚°ç”¨ï¼‰
        // messagingã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆãŒåˆæœŸåŒ–ã•ã‚ŒãŸå¾Œã«è¨­å®š
        function setupMessageListener() {
            if (typeof messaging !== 'undefined' && messaging.onMessage) {
                messaging.onMessage((payload) => {
                    console.log('Message received in foreground:', payload);
                    addLog(`ãƒ•ã‚©ã‚¢ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸å—ä¿¡: ${JSON.stringify(payload)}`, 'info');

                    // æ‰‹å‹•ã§é€šçŸ¥ã‚’è¡¨ç¤º
                    if (Notification.permission === 'granted') {
                        const title = payload.notification?.title || payload.data?.title || 'Kotohiro';
                        const body = payload.notification?.body || payload.data?.body || 'New notification';

                        new Notification(title, {
                            body: body,
                            icon: '/icon-192x192.png',
                            badge: '/badge-72x72.png'
                        });
                    }
                });
                addLog('ãƒ•ã‚©ã‚¢ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãƒªã‚¹ãƒŠãƒ¼è¨­å®šå®Œäº†', 'info');
            }
        }

        // Service Workerã®çŠ¶æ…‹ã‚’ãƒã‚§ãƒƒã‚¯
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.getRegistrations().then(registrations => {
                console.log('Registered Service Workers:', registrations);
                if (registrations.length > 0) {
                    addLog(`Service Workerç™»éŒ²æ¸ˆã¿: ${registrations.length}ä»¶`, 'info');
                }
            });
        }

        // åˆæœŸåŒ–
        checkAuthStatus();
    </script>
</body>
</html>
