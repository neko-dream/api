# 組織機能仕様書

## 概要

組織機能は、企業、自治体、議員などのグループ単位でKotohiroを利用できるマルチテナント機能を提供します。各組織は独立したデータ空間を持ち、メンバー間でトークセッションや意見を共有できます。

## 組織の定義

### 組織エンティティ
- **ID**: 一意の識別子（UUID）
- **名前**: 組織名（最大255文字）
- **種別**:
  - 1: 通常組織
  - 2: 自治体
  - 3: 議員
  - ※ 0は無効な値として扱われ、組織作成時にエラーとなります
- **コード**: 組織固有のコード（4文字以上、ASCII英数字のみ）
- **オーナー**: 組織の所有者（ユーザーID）

### 組織コードの仕様
- 最小4文字
- 使用可能文字: ASCII英数字（a-z, A-Z, 0-9）のみ
- 大文字小文字を区別
- システム全体で一意である必要がある
- 作成後の変更不可
- 組織専用ログインで使用

## ロールと権限

### ロール階層

#### 1. メンバー（Member）- ロール値: 1
基本的な組織メンバーの権限
- トークセッションの作成・編集
- 意見の投稿
- ワークロードの閲覧・編集
- 組織情報の閲覧
- 組織アカウントでのログイン
- 自身のアカウント管理
- 分析結果の閲覧（未実装）

#### 2. 管理者（Admin）- ロール値: 2
組織の管理権限を持つメンバー
- メンバーの全権限に加えて：
- 通報のモデレート
- 組織アカウントの作成・更新・削除
- 組織メンバーのパスワードリセット
- 組織情報の編集
- ユーザー招待（DisplayID指定）

#### 3. オーナー（Owner）- ロール値: 3
組織の最高権限者（各組織に1名のみ）
- 管理者の全権限に加えて：
- 組織の削除
- 他ユーザーへの管理者権限付与
- オーナー権限の譲渡
- 組織IDの変更

#### 4. 運営（SuperAdmin）- ロール値: 4
サービス全体の管理者
- 全組織横断的な操作権限
- 新規組織の作成
- 任意の組織へのアクセス

### 権限の階層性
- 上位ロールは下位ロールの全権限を含む
- 自分と同等以下のロールのみ付与可能
- ロール変更は管理者以上のみ実行可能

## メンバー管理

### メンバーシップの特徴
- 1ユーザーが複数の組織に所属可能
- 組織ごとに異なるロールを持てる
- 組織間のデータは完全に分離

### メンバー追加方法

#### 1. 新規ユーザー招待（Invite User）
- 運営のみ実行可能
- 新規ユーザーアカウントを作成
- 招待メールで認証情報を送信

#### 2. 既存ユーザー追加（Add User）
- 既存のKotohiroユーザーを組織に追加
- ロールを指定して追加

## 認証とセッション管理

### 組織ログイン
- ログイン時に組織コードを指定可能
- JWTトークンに組織IDとロールを含む
- セッションは現在の組織コンテキストを保持

### データアクセス制御
- API応答は組織コンテキストでフィルタリング
- 組織間のデータアクセスは不可（運営除く）
- 完全なテナント分離を実現

## ビジネスルール

### 組織作成
- 運営のみ作成可能（開発環境除く）
- 組織名は一意である必要がある
- 組織コードは一意である必要がある
- 組織種別は1〜3の有効な値である必要がある（0は無効）

### オーナーシップ
- 各組織に1名のオーナーが必須
- オーナーは削除不可（譲渡のみ可能）
- オーナー不在の組織は作成不可

### データ分離
- 組織Aのユーザーは組織Bのデータを閲覧不可
- トークセッション、意見、投票は組織単位で管理
- 分析結果も組織内のデータのみを対象

## データベース設計

### organizationsテーブル
```sql
- organization_id: UUID (主キー)
- organization_type: INT
- name: VARCHAR(255)
- owner_id: UUID
- code: VARCHAR(50) (ユニーク制約)
```

### organization_usersテーブル
```sql
- organization_user_id: UUID (主キー)
- user_id: UUID
- organization_id: UUID
- role: INT (デフォルト: 0)
- created_at: TIMESTAMP
- updated_at: TIMESTAMP
```

### 関連テーブル
- `sessions`: organization_idカラムで組織コンテキストを保持
- `auth_states`: organization_idカラムで組織ベース認証をサポート
- `password_auth`: 組織メンバーのパスワード認証情報を保存

## APIエンドポイント

### 組織管理
- `GET /organizations` - ユーザーが所属する組織一覧
- `POST /organizations` - 組織作成（運営のみ）
- `GET /auth/organization/{code}/validate` - 組織コード検証

### メンバー管理
- `POST /organizations/{id}/invite` - 新規ユーザー招待（運営のみ）
- `POST /organizations/{id}/invite_user` - 既存ユーザーを組織に追加

### 認証
- ログインエンドポイントで組織コードを使用した組織ログインが可能

## 実装状況

### 実装済み
- ドメインモデルとリポジトリ
- 組織作成とコード検証
- 組織種別のバリデーション（0を無効として防止）
- 基本的なロール定義と階層
- メール招待機能
- ユーザーの組織一覧取得
- コード検証エンドポイント

### 未実装
- 完全な組織ベースログインフロー
- APIレベルでの完全なRBAC実施
- ロール変更管理API
- オーナー譲渡機能
- 組織削除機能
- 管理者によるパスワードリセット
- 組織スコープでの通報モデレート
- 完全なマルチテナンシーデータフィルタリング

## 今後の拡張予定
- 組織ごとの利用統計
- 組織間連携機能
- 組織ごとのカスタマイズ設定
- 組織ごとの請求管理
