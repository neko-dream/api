# 組織認証ガイド

このドキュメントでは、Kotohiroにおける組織ベースの認証の仕組みを説明します。

## 概要

## 主要な概念

### 組織コード（OrganizationCode）

- 各組織の一意の識別子（例：`KOTOHIRO`）
- ログイン時に、どの組織のコンテキストで認証するかを指定するために使用
- 適切なフォーマットと存在を確認するため検証される

### 組織内の役割（Organization Roles）

ユーザーは各組織内で特定の役割を持ちます：

- **SuperUser (10)**: システム全体の管理者
- **Owner (20)**: 組織のオーナー（全権限を持つ）
- **Admin (30)**: 組織の管理者
- **Member (40)**: 一般メンバー

## 認証フロー

### 1. ユーザーの所属組織一覧の取得

特定の組織にログインする前に、ユーザーは自分が所属する組織の一覧を取得できます：

```http
GET /organizations
```

レスポンス例：
```json
[
  {
    "organizationID": "00000000-0000-0000-0000-000000000000",
    "name": "kotohiro株式会社",
    "code": "KOTOHIRO",
    "role": "owner"
  }
]
```

### 2. 組織ログイン

組織コンテキストでログインするには：

```http
GET /auth/authorize?provider=google&organization_code=KOTOHIRO&redirect_url=https://app.example.com
```

パラメータ：

- `provider`: 認証プロバイダー（google、line、dev, password）
- `organization_code`: 組織の一意のコード
- `redirect_url`: 認証成功後のリダイレクト先URL

## APIエンドポイント

### 認証エンドポイント

| エンドポイント           | メソッド | 説明                       |
| ------------------------ | -------- | -------------------------- |
| `/auth/{provider}/login` | GET      | OAuthログインを開始        |
| `/auth/password/login`   | POST     | 開発環境専用の組織ログイン |

### 組織管理

| エンドポイント            | メソッド | 説明                         |
| ------------------------- | -------- | ---------------------------- |
| `/organizations`          | GET      | ユーザーの所属組織一覧を取得 |
| `/organizations`          | POST     | 新しい組織を作成（運営のみ） |
| `/organizations/validate` | GET      | 組織コードの検証             |
| `/organizations/invite`   | POST     | 組織にユーザーを招待         |

### エイリアスの管理

| エンドポイント                   | メソッド | 説明                       |
| -------------------------------- | -------- | -------------------------- |
| `/organizations/aliases`         | GET      | 組織のエイリアス一覧を取得 |
| `/organizations/aliases`         | POST     | 新しいエイリアスを作成     |
| `/organizations/aliases/{alias}` | DELETE   | エイリアスを削除           |

## 一般的な使用例

### 組織の切り替え

ユーザーは以下の手順で組織を切り替えることができます：

1. 現在のセッションからログアウト
2. 異なる組織コードで新しいログインを開始

### 組織スコープの操作

組織コンテキストで認証されている場合：

- トークセッションを組織メンバーに限定できる
- ユーザー一覧には組織メンバーのみが表示される
- 管理操作には適切な組織内の役割が必要

## エラー処理

一般的なエラーシナリオ：

- **無効な組織コード**: 組織コンテキストなしでログインページにリダイレクト
- **メンバーではない**: 認証は成功するが組織コンテキストなし
- **組織が見つからない**: 無効なコードとして扱われ、列挙を防ぐためエラーは公開されない
