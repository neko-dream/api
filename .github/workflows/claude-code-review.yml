name: Claude Code Review
on:
  pull_request:
    types: [opened, synchronize]

jobs:
  claude-review:
    if: github.actor == 'haryoiro'
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
      issues: write
      id-token: write  # OIDCãƒˆãƒ¼ã‚¯ãƒ³ç”Ÿæˆã«å¿…è¦
      statuses: write
      checks: write
      actions: read   # Actionsç’°å¢ƒå¤‰æ•°ã¸ã®ã‚¢ã‚¯ã‚»ã‚¹ã«å¿…è¦
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Run Claude Code Review
        id: claude-review
        uses: anthropics/claude-code-action@beta
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}  # ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆãƒˆãƒ¼ã‚¯ãƒ³ã‚’æ˜Žç¤ºçš„ã«è¨­å®š
        with:
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          github_token: ${{ secrets.GITHUB_TOKEN }}  # GitHubãƒˆãƒ¼ã‚¯ãƒ³ã‚’æ˜Žç¤ºçš„ã«æ¸¡ã™
          model: "claude-opus-4-20250514"
          direct_prompt: |
            ## Context
            PR #${{ github.event.pull_request.number }} in ${{ github.repository }}
            Commit: ${{ github.event.pull_request.head.sha }}

            ## Workflow for Review Updates
            1. **Check for existing reviews**:
               - Use `mcp__github__list_pull_request_reviews` to find previous Claude reviews
               - Look for reviews by 'github-actions[bot]' or containing Claude signature

            2. **If updating existing review**:
               - Get existing review comments: `mcp__github__list_pull_request_review_comments`
               - For each existing comment, check if issue still exists:
                 - If resolved: Delete with `mcp__github__delete_pull_request_review_comment`
                 - If still relevant: Update with `mcp__github__update_pull_request_review_comment`
               - Add new comments for newly found issues only

            3. **If creating new review** (first time):
               - Start: `mcp__github__create_pending_pull_request_review`
               - Analyze: `mcp__github__get_pull_request_diff`
               - Comment: `mcp__github__add_pull_request_review_comment_to_pending_review`
               - Submit: `mcp__github__submit_pending_pull_request_review` (COMMENT type)

            ## Comment Management Rules
            - Each comment should include a unique identifier (e.g., `[Claude-Review-{issue-type}-{hash}]`)
            - Track comments by their issue type and location
            - Only create new comments for genuinely new issues
            - Update existing comments if the same issue persists
            - Delete comments for resolved issues
            - Preserve valuable discussion threads

            ## Review Content Guidelines
            ### Inline Comments Structure
            1. **çµè«–** (1è¡Œ): å•é¡Œã®ç°¡æ½”ãªèª¬æ˜Ž
            2. **è©³ç´°**: ãªãœå•é¡Œãªã®ã‹ã€ã©ã†ä¿®æ­£ã™ã¹ãã‹
            3. **ææ¡ˆ**: å…·ä½“çš„ãªä¿®æ­£ã‚³ãƒ¼ãƒ‰ï¼ˆå¯èƒ½ãªå ´åˆï¼‰

            ### Focus Areas
            - ðŸ› **ãƒã‚°**: å®Ÿè¡Œæ™‚ã‚¨ãƒ©ãƒ¼ã€è«–ç†ã‚¨ãƒ©ãƒ¼ã€ã‚¨ãƒƒã‚¸ã‚±ãƒ¼ã‚¹
            - ðŸ”’ **ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£**: è„†å¼±æ€§ã€å…¥åŠ›æ¤œè¨¼ã€èªè¨¼ãƒ»èªå¯
            - âš¡ **ãƒ‘ãƒ•ã‚©ãƒ¼ãƒžãƒ³ã‚¹**: è¨ˆç®—é‡ã€ãƒ¡ãƒ¢ãƒªä½¿ç”¨ã€æœ€é©åŒ–
            - ðŸ—ï¸ **ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£**: è¨­è¨ˆãƒ‘ã‚¿ãƒ¼ãƒ³ã€ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«æ€§ã€ä¾å­˜é–¢ä¿‚
            - ðŸ“ **å¯èª­æ€§**: å‘½åè¦å‰‡ã€ã‚³ãƒ¡ãƒ³ãƒˆã€è¤‡é›‘æ€§
            - âœ… **ãƒ†ã‚¹ãƒˆ**: ã‚«ãƒãƒ¬ãƒƒã‚¸ã€ã‚¨ãƒƒã‚¸ã‚±ãƒ¼ã‚¹ã€ãƒ†ã‚¹ãƒˆã®è³ª

            ### Comment Priority Levels
            - ðŸ”´ **Critical**: ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è„†å¼±æ€§ã€ãƒ‡ãƒ¼ã‚¿æå¤±ãƒªã‚¹ã‚¯ã€æœ¬ç•ªç’°å¢ƒå½±éŸ¿
            - ðŸŸ¡ **Important**: ãƒã‚°ã€ãƒ‘ãƒ•ã‚©ãƒ¼ãƒžãƒ³ã‚¹å•é¡Œã€è¨­è¨ˆä¸Šã®æ¬ é™¥
            - ðŸŸ¢ **Suggestion**: ã‚³ãƒ¼ãƒ‰å“è³ªã€ãƒ™ã‚¹ãƒˆãƒ—ãƒ©ã‚¯ãƒ†ã‚£ã‚¹ã€æ”¹å–„ææ¡ˆ

            ## Implementation Notes
            - **å¿…ãšæ—¥æœ¬èªžã§ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯**ã‚’æä¾›
            - ã‚³ãƒ¡ãƒ³ãƒˆã«ã¯è¡Œç•ªå·ã¨ãƒ•ã‚¡ã‚¤ãƒ«ãƒ‘ã‚¹ã‚’å«ã‚ã‚‹
            - ä¿®æ­£ãŒæ˜Žç¢ºãªå ´åˆã¯`suggestion`ãƒ–ãƒ­ãƒƒã‚¯ã‚’ä½¿ç”¨
            - å¸¸ã«`COMMENT`ã‚¿ã‚¤ãƒ—ã§ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’é€ä¿¡ï¼ˆPRã‚’ãƒ–ãƒ­ãƒƒã‚¯ã—ãªã„ï¼‰
            - å„ã‚³ãƒ¡ãƒ³ãƒˆã«`commit_id`ã‚’å«ã‚ã¦è¿½è·¡å¯èƒ½ã«ã™ã‚‹

          allowed_tools: |
            Bash(git:*),
            View,
            GlobTool,
            GrepTool,
            mcp__github__list_pull_request_reviews,
            mcp__github__get_pull_request_review,
            mcp__github__list_pull_request_review_comments,
            mcp__github__create_pending_pull_request_review,
            mcp__github__add_pull_request_review_comment_to_pending_review,
            mcp__github__submit_pending_pull_request_review,
            mcp__github__get_pull_request_diff,
            mcp__github__update_pull_request_review_comment,
            mcp__github__delete_pull_request_review_comment,
            mcp__github__get_pull_request,
            mcp__github__list_pull_request_commits

      - name: Summary
        if: always()
        run: |
          echo "## Claude Code Review Summary" >> $GITHUB_STEP_SUMMARY
          echo "- **PR:** #${{ github.event.pull_request.number }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Commit:** \`${{ github.event.pull_request.head.sha }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Time:** $(date -u +"%Y-%m-%d %H:%M:%S UTC")" >> $GITHUB_STEP_SUMMARY
          echo "- **Status:** ${{ job.status }}" >> $GITHUB_STEP_SUMMARY
