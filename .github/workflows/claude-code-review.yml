name: Claude Code Review
on:
  pull_request:
    types: [opened, synchronize]

jobs:
  claude-review:
    if: github.actor == 'haryoiro'
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
      issues: write
      id-token: write  # OIDCãƒˆãƒ¼ã‚¯ãƒ³ç”Ÿæˆã«å¿…è¦
      statuses: write
      checks: write
      actions: read   # Actionsç’°å¢ƒå¤‰æ•°ã¸ã®ã‚¢ã‚¯ã‚»ã‚¹ã«å¿…è¦
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Run Claude Code Review
        id: claude-review
        uses: anthropics/claude-code-action@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}  # ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆãƒˆãƒ¼ã‚¯ãƒ³ã‚’æ˜Žç¤ºçš„ã«è¨­å®š
        with:
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          github_token: ${{ secrets.GITHUB_TOKEN }}  # GitHubãƒˆãƒ¼ã‚¯ãƒ³ã‚’æ˜Žç¤ºçš„ã«æ¸¡ã™
          claude_args: |
            --mcp-config ./mcp-servers.json
            --allowedTools "Bash(git:*), View, GlobTool, GrepTool, mcp__github__get_pull_request_reviews, mcp__github__get_pull_request_review_comments, mcp__github__get_pull_request_diff, mcp__github__create_pending_pull_request_review, mcp__github__add_comment_to_pending_review, mcp__github__submit_pending_pull_request_review"
            --model "claude-opus-4-20250514"
          prompt: |
            ## Context
            ã‚ãªãŸã¯ã‚³ãƒ¼ãƒ‰ãƒ¬ãƒ“ãƒ¥ã‚¢ãƒ¼ã§ã™ã€‚PRã«å¯¾ã—ã¦æ—¢å­˜ã®ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚³ãƒ¡ãƒ³ãƒˆã‚’æ›´æ–°ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚

            ## âš ï¸ é‡è¦ãªåˆ¶ç´„
            - **æ€è€ƒãƒ—ãƒ­ã‚»ã‚¹ã‚„é€²æ—çŠ¶æ³ã‚’ã‚³ãƒ¡ãƒ³ãƒˆã¨ã—ã¦æŠ•ç¨¿ã—ãªã„**
            - **ã€Œãƒ¬ãƒ“ãƒ¥ãƒ¼ä¸­...ã€ã€Œç¢ºèªä¸­...ã€ãªã©ã®ä¸€æ™‚çš„ãªã‚³ãƒ¡ãƒ³ãƒˆã‚’ä½œæˆã—ãªã„**
            - **æœ€çµ‚çš„ãªãƒ¬ãƒ“ãƒ¥ãƒ¼çµæžœã®ã¿ã‚’ã‚³ãƒ¡ãƒ³ãƒˆã¨ã—ã¦æŠ•ç¨¿ã™ã‚‹**
            - **åŒã˜å•é¡Œã«å¯¾ã—ã¦è¤‡æ•°ã®ã‚³ãƒ¡ãƒ³ãƒˆã‚’ä½œæˆã—ãªã„**

            ## å®Ÿè¡Œæ‰‹é †ï¼ˆåŽ³å¯†ã«å¾“ã†ã“ã¨ï¼‰

            ### Step 1: æ—¢å­˜ãƒ¬ãƒ“ãƒ¥ãƒ¼ã®ç¢ºèªï¼ˆã‚µã‚¤ãƒ¬ãƒ³ãƒˆã§å®Ÿè¡Œï¼‰
            1. get_pull_request_reviews ã§PR #${{ github.event.pull_request.number }}ã®æ—¢å­˜ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’å–å¾—
            2. github-actions[bot]ã«ã‚ˆã‚‹æ—¢å­˜ã®ãƒ¬ãƒ“ãƒ¥ãƒ¼IDã‚’è¨˜éŒ²
            3. æ—¢å­˜ãƒ¬ãƒ“ãƒ¥ãƒ¼ãŒã‚ã‚‹å ´åˆã¯ã€get_pull_request_review_comments ã§æ—¢å­˜ã‚³ãƒ¡ãƒ³ãƒˆã‚’å–å¾—
            4. å„ã‚³ãƒ¡ãƒ³ãƒˆã®bodyå†…ã®è­˜åˆ¥å­ [Claude-{hash}] ã‚’æŠ½å‡ºã—ã¦ãƒžãƒƒãƒ”ãƒ³ã‚°ä½œæˆ

            ### Step 2: å·®åˆ†è§£æžï¼ˆã‚µã‚¤ãƒ¬ãƒ³ãƒˆã§å®Ÿè¡Œï¼‰
            1. get_pull_request_diff ã§æœ€æ–°ã®å·®åˆ†ã‚’å–å¾—
            2. å„å¤‰æ›´ç®‡æ‰€ã‚’è§£æžã—ã¦å•é¡Œã‚’ç‰¹å®š
            3. å„å•é¡Œã«å¯¾ã—ã¦ä¸€æ„ãªè­˜åˆ¥å­ [Claude-{hash}] ã‚’ç”Ÿæˆï¼ˆãƒ•ã‚¡ã‚¤ãƒ«ãƒ‘ã‚¹+è¡Œç•ªå·ã®ãƒãƒƒã‚·ãƒ¥ï¼‰

            ### Step 3: ã‚³ãƒ¡ãƒ³ãƒˆç®¡ç†æˆ¦ç•¥ã®æ±ºå®šï¼ˆã‚µã‚¤ãƒ¬ãƒ³ãƒˆã§å®Ÿè¡Œï¼‰
            æ—¢å­˜ã‚³ãƒ¡ãƒ³ãƒˆãŒã‚ã‚‹å ´åˆ:
            - æ—¢å­˜ã‚³ãƒ¡ãƒ³ãƒˆã¨æ–°è¦å•é¡Œã‚’ç…§åˆ
            - è§£æ±ºæ¸ˆã¿å•é¡Œ: è§£æ±ºãƒªã‚¹ãƒˆã«è¿½åŠ ï¼ˆå¾Œã§è¿”ä¿¡ã‚³ãƒ¡ãƒ³ãƒˆã§å¯¾å¿œï¼‰
            - ç¶™ç¶šä¸­ã®å•é¡Œ: æ›´æ–°ãƒªã‚¹ãƒˆã«è¿½åŠ ï¼ˆæ–°ã—ã„ã‚³ãƒ¡ãƒ³ãƒˆã§çŠ¶æ³èª¬æ˜Žï¼‰
            - æ–°è¦å•é¡Œ: æ–°è¦ä½œæˆãƒªã‚¹ãƒˆã«è¿½åŠ 

            æ—¢å­˜ã‚³ãƒ¡ãƒ³ãƒˆãŒãªã„å ´åˆ:
            - ã™ã¹ã¦ã®å•é¡Œã‚’æ–°è¦ä½œæˆãƒªã‚¹ãƒˆã«è¿½åŠ 

            ### Step 4: ãƒ¬ãƒ“ãƒ¥ãƒ¼ã®å®Ÿè¡Œï¼ˆã“ã®æ™‚ç‚¹ã§åˆã‚ã¦ã‚³ãƒ¡ãƒ³ãƒˆã‚’ä½œæˆï¼‰

            #### ãƒ‘ã‚¿ãƒ¼ãƒ³A: æ—¢å­˜ã‚³ãƒ¡ãƒ³ãƒˆã¸ã®å¯¾å¿œã¨æ–°è¦å•é¡Œã®è¿½åŠ 
            ```python
            # ãƒšãƒ³ãƒ‡ã‚£ãƒ³ã‚°ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’ä½œæˆ
            create_pending_pull_request_review(
                owner=owner,
                repo=repo,
                pullNumber=pr_number
            )

            # è§£æ±ºæ¸ˆã¿å•é¡Œã¸ã®è¿”ä¿¡
            for comment in resolved_comments:
                add_comment_to_pending_review(
                    owner=owner,
                    repo=repo,
                    pullNumber=pr_number,
                    path=comment.path,
                    line=comment.line,
                    body="âœ… [Claude-{hash}] ã“ã®å•é¡Œã¯ä¿®æ­£ã•ã‚Œã¾ã—ãŸ",
                    side="RIGHT",
                    subjectType="line"
                )

            # ç¶™ç¶šä¸­ã®å•é¡Œã¸ã®æ›´æ–°ã‚³ãƒ¡ãƒ³ãƒˆ
            for comment in continuing_issues:
                add_comment_to_pending_review(
                    owner=owner,
                    repo=repo,
                    pullNumber=pr_number,
                    path=comment.path,
                    line=comment.line,
                    body="âš ï¸ [Claude-{hash}] ã¾ã å¯¾å¿œãŒå¿…è¦ã§ã™: {updated_description}",
                    side="RIGHT",
                    subjectType="line"
                )

            # æ–°è¦å•é¡Œã®è¿½åŠ 
            for issue in new_issues:
                add_comment_to_pending_review(
                    owner=owner,
                    repo=repo,
                    pullNumber=pr_number,
                    path=issue.path,
                    line=issue.line,
                    body=body_with_identifier,
                    side="RIGHT",
                    subjectType="line"
                )

            # ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’é€ä¿¡
            submit_pending_pull_request_review(
                owner=owner,
                repo=repo,
                pullNumber=pr_number,
                event="COMMENT",
                body="ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’æ›´æ–°ã—ã¾ã—ãŸã€‚ä¸Šè¨˜ã®ã‚³ãƒ¡ãƒ³ãƒˆã‚’ã”ç¢ºèªãã ã•ã„ã€‚"
            )
            ãƒ‘ã‚¿ãƒ¼ãƒ³B: æ–°è¦ãƒ¬ãƒ“ãƒ¥ãƒ¼ã®å ´åˆ
            python# ãƒšãƒ³ãƒ‡ã‚£ãƒ³ã‚°ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’ä½œæˆ
            create_pending_pull_request_review(
                owner=owner,
                repo=repo,
                pullNumber=pr_number
            )

            # ã™ã¹ã¦ã®å•é¡Œã‚’ã‚³ãƒ¡ãƒ³ãƒˆã¨ã—ã¦è¿½åŠ 
            for issue in all_issues:
                add_comment_to_pending_review(
                    owner=owner,
                    repo=repo,
                    pullNumber=pr_number,
                    path=issue.path,
                    line=issue.line,
                    body=body_with_identifier,
                    side="RIGHT",
                    subjectType="line"
                )

            # ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’é€ä¿¡
            submit_pending_pull_request_review(
                owner=owner,
                repo=repo,
                pullNumber=pr_number,
                event="COMMENT",
                body="ã‚³ãƒ¼ãƒ‰ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’å®Ÿæ–½ã—ã¾ã—ãŸã€‚ä¸Šè¨˜ã®ã‚³ãƒ¡ãƒ³ãƒˆã‚’ã”ç¢ºèªãã ã•ã„ã€‚"
            )
            ã‚³ãƒ¡ãƒ³ãƒˆãƒ•ã‚©ãƒ¼ãƒžãƒƒãƒˆï¼ˆåŽ³å¯†ã«å¾“ã†ï¼‰
            å„ã‚³ãƒ¡ãƒ³ãƒˆã¯ä»¥ä¸‹ã®å½¢å¼ã§ä½œæˆ:
            [Claude-{8æ–‡å­—ã®ãƒãƒƒã‚·ãƒ¥}] ðŸ”´ Critical: ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è„†å¼±æ€§

            SQLã‚¤ãƒ³ã‚¸ã‚§ã‚¯ã‚·ãƒ§ãƒ³ã®è„†å¼±æ€§ãŒã‚ã‚Šã¾ã™ã€‚

            **ç†ç”±**: ãƒ¦ãƒ¼ã‚¶ãƒ¼å…¥åŠ›ãŒç›´æŽ¥SQLã‚¯ã‚¨ãƒªã«åŸ‹ã‚è¾¼ã¾ã‚Œã¦ã„ã¾ã™ã€‚

            **ä¿®æ­£æ¡ˆ**:
            ```suggestion
            const query = 'SELECT * FROM users WHERE id = ?';
            db.query(query, [userId], callback);

            ## è­˜åˆ¥å­ãƒ«ãƒ¼ãƒ«
            - å½¢å¼: `[Claude-{hash}]` ï¼ˆhashã¯8æ–‡å­—ï¼‰
            - hashç”Ÿæˆ: `{file_path}:{line_number}:{issue_type}` ã®MD5ãƒãƒƒã‚·ãƒ¥ã®å…ˆé ­8æ–‡å­—
            - å„ã‚³ãƒ¡ãƒ³ãƒˆã®æœ€åˆã®è¡Œã«å¿…ãšå«ã‚ã‚‹

            ## å„ªå…ˆåº¦ãƒžãƒ¼ã‚«ãƒ¼
            - ðŸ”´ Critical: æœ¬ç•ªç’°å¢ƒã«å½±éŸ¿ã™ã‚‹é‡å¤§ãªå•é¡Œ
            - ðŸŸ¡ Important: ä¿®æ­£ãŒæŽ¨å¥¨ã•ã‚Œã‚‹å•é¡Œ
            - ðŸŸ¢ Suggestion: æ”¹å–„ææ¡ˆ

            ## ç¦æ­¢äº‹é …
            1. âŒ ã€Œãƒ¬ãƒ“ãƒ¥ãƒ¼ä¸­...ã€ã®ã‚ˆã†ãªé€²æ—ã‚³ãƒ¡ãƒ³ãƒˆã‚’ä½œæˆã—ãªã„
            2. âŒ åŒã˜å ´æ‰€ã«è¤‡æ•°ã®ã‚³ãƒ¡ãƒ³ãƒˆã‚’ä½œæˆã—ãªã„
            3. âŒ è­˜åˆ¥å­ãªã—ã®ã‚³ãƒ¡ãƒ³ãƒˆã‚’ä½œæˆã—ãªã„
            4. âŒ REQUEST_CHANGESã‚„APPROVEã‚’ä½¿ã‚ãªã„ï¼ˆå¸¸ã«COMMENTï¼‰
            5. âŒ æ€è€ƒãƒ—ãƒ­ã‚»ã‚¹ã‚’ã‚³ãƒ¡ãƒ³ãƒˆã¨ã—ã¦æŠ•ç¨¿ã—ãªã„

            ## MCPåˆ¶é™äº‹é …ã¸ã®å¯¾å¿œ
            - æ—¢å­˜ã‚³ãƒ¡ãƒ³ãƒˆã®å‰Šé™¤ã¯ã§ããªã„ â†’ âœ…ãƒžãƒ¼ã‚¯ã§è§£æ±ºæ¸ˆã¿ã‚’ç¤ºã™
            - æ—¢å­˜ã‚³ãƒ¡ãƒ³ãƒˆã®æ›´æ–°ã¯ã§ããªã„ â†’ æ–°ã—ã„ã‚³ãƒ¡ãƒ³ãƒˆã§çŠ¶æ³ã‚’èª¬æ˜Ž
            - ã™ã¹ã¦ã®ã‚³ãƒ¡ãƒ³ãƒˆã¯`add_comment_to_pending_review`ã§è¿½åŠ ã™ã‚‹

            ## Context
            - Repository: ${{ github.repository }}
            - PR: #${{ github.event.pull_request.number }}
            - Commit: ${{ github.event.pull_request.head.sha }}
            - è¨€èªž: æ—¥æœ¬èªžã§ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯
      - name: Summary
        if: always()
        run: |
          echo "## Claude Code Review Summary" >> $GITHUB_STEP_SUMMARY
          echo "- **PR:** #${{ github.event.pull_request.number }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Commit:** \`${{ github.event.pull_request.head.sha }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Time:** $(date -u +"%Y-%m-%d %H:%M:%S UTC")" >> $GITHUB_STEP_SUMMARY
          echo "- **Status:** ${{ job.status }}" >> $GITHUB_STEP_SUMMARY
